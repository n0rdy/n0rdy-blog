<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.5991d603939a6d188be342b278a4555db90f163903158c623d2c39fde3d82cb3.js"></script>



<script defer data-domain="n0rdy.foo" src="https://plausible.n0rdy.foo/js/script.js"></script>




    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.ico>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

  
    <meta property="og:image" content="https://n0rdy.foo/covers/drawings/20241210.webp" />
    <meta name="twitter:image" content="https://n0rdy.foo/covers/drawings/20241210.webp"/>
          <meta name="twitter:card" content="summary_large_image">
        <meta property="og:image:width" content="2154">
        <meta property="og:image:height" content="1668">
      <meta property="og:image:type" content="image/webp">
  
<title itemprop="name">n0rdy - Demystifying OTPs: the logic behind the offline generation of tokens</title>
<meta property="og:title" content=n0rdy&#32;-&#32;Demystifying&#32;OTPs:&#32;the&#32;logic&#32;behind&#32;the&#32;offline&#32;generation&#32;of&#32;tokens />
<meta name="twitter:title" content=n0rdy&#32;-&#32;Demystifying&#32;OTPs:&#32;the&#32;logic&#32;behind&#32;the&#32;offline&#32;generation&#32;of&#32;tokens />
<meta itemprop="name" content=n0rdy&#32;-&#32;Demystifying&#32;OTPs:&#32;the&#32;logic&#32;behind&#32;the&#32;offline&#32;generation&#32;of&#32;tokens />
<meta name="application-name" content=n0rdy&#32;-&#32;Demystifying&#32;OTPs:&#32;the&#32;logic&#32;behind&#32;the&#32;offline&#32;generation&#32;of&#32;tokens />
<meta property="og:site_name" content="n0rdy personal blog" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://n0rdy.foo/posts/20241210/otp-offline-generation/" />
<link rel="canonical" href="https://n0rdy.foo/posts/20241210/otp-offline-generation/" itemprop="url" />
<meta name="url" content="https://n0rdy.foo/posts/20241210/otp-offline-generation/" />
<meta name="twitter:url" content="https://n0rdy.foo/posts/20241210/otp-offline-generation/" />
<meta property="og:url" content="https://n0rdy.foo/posts/20241210/otp-offline-generation/" />


<meta property="og:updated_time" content="2024-12-10T17:30:00&#43;01:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://n0rdy.foo/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@_n0rdy_" />
    <meta name="twitter:creator" content="@_n0rdy_" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="n0rdy personal blog" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.145.0">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #eee;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9d9d9d;
        --link-color: #268bd2;
        --date-color: #9a9a9a;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #fff;
        --code-background-color: #515151;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://n0rdy.foo/">
                <img src="/images/avatar.webp" alt="brand image">
            </a>
        
        
            <a href="https://n0rdy.foo/">
                <h1>n0rdy</h1>
            </a>
        
    </h1>
    <p class="lead">
    Exploring software engineering and tech
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            
                <li class="heading">
                    <a href="https://mail.n0rdy.foo/subscription/form" target="_blank" rel="noopener noreferrer">Subscribe</a>
                </li>
            

            
                
                
            
                
                
            
            
                
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                
            
            
                
                
                        
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
            
                
                
                        
                
            
                
                    <li class="heading">
                        <a href="/tags/">Tags</a>
                    </li>
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/n0rdy" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>





    <a target="_blank" class="social" title="X" href="https://x.com/_n0rdy_" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 512 472.799">
            <path fill="currentColor" d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z"/>
        </svg>
    </a>


    <a target="_blank" class="social" title="Bluesky" href="https://bsky.app/profile/n0rdy.foo" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 568 501">
            <path fill="currentColor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873C309.719 181.681 379.759 82.5526 444.879 33.6637C491.866 -1.61183 568 -28.9064 568 57.9464C568 75.2916 558.055 203.659 552.222 224.501C531.947 296.954 458.067 315.434 392.347 304.249C507.222 323.8 536.444 388.56 473.333 453.32C353.473 576.312 301.061 422.461 287.631 383.039C285.169 375.812 284.017 372.431 284 375.306C283.983 372.431 282.831 375.812 280.369 383.039C266.939 422.461 214.527 576.312 94.6667 453.32C31.5556 388.56 60.7778 323.8 175.653 304.249C109.933 315.434 36.0535 296.954 15.7778 224.501C9.94525 203.659 0 75.2916 0 57.9464C0 -28.9064 76.1345 -1.61183 123.121 33.6637Z"/>
        </svg>
    </a>


    <a target="_blank" class="social" rel="me" title="Mastodon" href="https://fosstodon.org/@n0rdy" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26c-1.31.15-2.6.3-3.97.24c-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42c1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5c-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56 0 5.02.3 6.47.96c0 0 2.83 1.27 2.83 5.61c0 0 .04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56c-.56-.63-1.3-.96-2.23-.96c-1.06 0-1.87.41-2.42 1.23l-.5.88l-.5-.88c-.56-.82-1.36-1.23-2.43-1.23c-.92 0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62c1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93c.9 0 1.35.56 1.35 1.62v5.11H18V8.91Z"/>
        </svg>
    </a>











    <a target="_blank" class="social" title="RSS Feed" href="/posts/index.xml" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>


    <a target="_blank" class="social" title="Email" href="mailto:hello@n0rdy.foo" rel="nofollow">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 n0rdy personal blog. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://n0rdy.foo/posts/20241210/otp-offline-generation/">Demystifying OTPs: the logic behind the offline generation of tokens</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2024-12-10T17:30:00&#43;0100" class="post-date">
        December 10, 2024
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>19 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-tech">
        <a href="https://n0rdy.foo/tags/tech">tech</a>
      </li>
      
      <li class="tag-web">
        <a href="https://n0rdy.foo/tags/web">web</a>
      </li>
      
      <li class="tag-security">
        <a href="https://n0rdy.foo/tags/security">security</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p>Hello there! Another evening, on my way back home, I decided to check the mailbox. I don&rsquo;t mean my email inbox, but the old-school actual box where the postman puts the physical letters. And to my great surprise, I found an envelope there with something inside! While opening it, I spent a few moments hoping that it&rsquo;s the decades delayed letter from Hogwarts. But then I had to get back down to Earth, once I noticed that it&rsquo;s a boring &ldquo;grown-up&rdquo; letter from the bank. I skimmed through the text and realized that my &ldquo;digital-only&rdquo; bank for cool kids had been acquired by the biggest player on the local market. And as a token of the new beginning, they added this to the envelope:</p>
<p><img src="/images/drawings/20241210-0001.webp" alt="image"></p>
<p>Alongside the instructions on how to use it.</p>
<p>If you are like me, and have never come across such a piece of the tech innovation, let me share what I learned from the letter: new owners decided to enforce the security policies from their company, which means that all the user accounts from now on will have the <a href="https://en.wikipedia.org/wiki/Multi-factor_authentication" target="_blank" rel="nofollow">MFA</a> enabled (kudos for that, btw). And the device you could see above generates one-time tokens 6-digits long that are used as a second factor while logging in to your bank account. Basically, the same way as apps like Authy, Google Authenticator or 2FAS work, but in a physical shape.</p>
<p>So, I gave it a try, and the login process went smoothly: the device showed me a 6-digits code, I entered it in my banking app, and this got me in. Hooray! But then something struck me: how does this thing work? There is no way it is connected to the internet somehow, but it manages to generate correct codes that are accepted by my bank server. Hm&hellip; Could it have a SIM-card or something similar inside? No way!</p>
<p>Realizing that my life will never be the same, I began wondering about apps I&rsquo;ve mentioned above (Authy and friends)? My inner researcher was awakened, so I switched my phone into the airplane mode and, to my big surprise, realized that they work perfectly fine offline: they keep generating codes that are accepted by the servers of the apps. Interesting!</p>
<p>Not sure about you, but I&rsquo;ve always taken the one-time token flow for granted and have never actually given it a proper thought (especially due to the fact that these days it is rare that my phone has no internet unless I&rsquo;m doing some outdoor adventures), so that was the root cause of my surprise. Otherwise, it makes a perfect sense from the security point of view to work this way, as the generation process is purely local, so safe-ish from the external actors. But how does it work?</p>
<p>Well, modern technologies like Google or ChatGPT make it easy to find the answer easily. But this technical problem seemed fun to me, so decided to give it a try and solve it on my own first.</p>
<h2 id="requirements">Requirements</h2>
<p>Let&rsquo;s start with what we have:</p>
<ul>
<li>an offline device that generates 6-digits codes</li>
<li>a server that accepts these codes, validates them and gives a green signal if they are correct</li>
</ul>
<p>The server validation part hints that the server must be able to generate the same code as the offline device to compare them. Hm..that can be helpful.</p>
<p>My further observations of my new &ldquo;toy&rdquo; brought even more discoveries:</p>
<ul>
<li>if I turn it off and then on, usually I can see the same code as before</li>
<li>however, occasionally, it changes</li>
</ul>
<p>The only logic explanation I could come up with is that these codes have a certain lifetime. I&rsquo;d like to tell a story of me trying to count the duration of it in &ldquo;1-2-3-&hellip;-N&rdquo; fashion, but it won&rsquo;t be true: I got a big hint from the apps like Authy and Co, where I saw the 30 seconds TTL. Good find, let&rsquo;s add this to the list of the known facts.</p>
<p>Let&rsquo;s summarize the requirements we have so far:</p>
<ul>
<li>predictable (rather than random) code generation in 6 digits format</li>
<li>the generation logic should be reproducible, which allows getting the same result regardless of the platform</li>
<li>the code lifetime is 30 seconds, which means that within this timeframe the generation algorithm produces the same value</li>
</ul>
<h2 id="the-big-question">The big question</h2>
<p>All right, but the main question remains unanswered: how come the offline app can generate the value that will match the one from the other app? What do they have in common?</p>
<p>If you are into the Lord of the Rings universe, you might remember how Bilbo played a riddle game with Gollum, and got this one to solve:</p>
<blockquote>
<p>This thing all things devours:
Birds, beasts, trees, flowers;
Gnaws iron, bites steel;
Grinds hard stones to meal;
Slays king, ruins town,
And beats high mountain down.</p></blockquote>
<p>Spoiler alert, but Mr. Baggins got lucky and came up with the correct answer accidentally - &ldquo;Time!&rdquo;. Believe it or not, but this is exactly the answer to our riddle as well: any 2 (or more) apps have access to the same time as long as they have an embedded clock within. The latter is not a problem these days, and the device in question is big enough to fit it. Look around, and the chances are that the time on your hand watch, mobile phone, TV, oven, and clock on the wall is the same. We are into something here, it seems like we have found the base for the OTP (one-time password) computing!</p>
<h3 id="challenges">Challenges</h3>
<p>Relying on time has its own set of challenges:</p>
<ul>
<li>timezones - which one to use?</li>
<li>clocks tend to get out of sync, and it&rsquo;s <a href="https://en.wikipedia.org/wiki/Clock_synchronization" target="_blank" rel="nofollow">a big challenge</a> in the distributed systems</li>
</ul>
<p>Let&rsquo;s address them one by one:</p>
<ul>
<li>timezone: the simplest solution here is to make sure that all the devices rely on the same zone, and UTC can be a good location-agnostic candidate</li>
<li>as for clocks getting out of sync: actually, we might not even need to solve it but rather accept as something inevitable, as long as the drift is within the second or two, which might be tolerable considering the 30 seconds TTL. The hardware producer of the device should be able to predict when such drift will be achieved, so then the device will use it as its expiration date, and the bank will simply replace them with the new ones, or will have a way to connect them to the network to calibrate the clock. At least, that&rsquo;s my train of thoughts here.</li>
</ul>
<h2 id="implementation">Implementation</h2>
<p>Ok, this is settled, so let&rsquo;s try to implement the very first version of our algorithm using time as the basis. Since we are interested in a 6 digits result, it sounds like a smart choice to rely on a timestamp rather than the human-readable date. Let&rsquo;s start from there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span></code></pre></div><p>According to the Go docs, the <code>.Unix()</code> returns</p>
<blockquote>
<p>the number of seconds elapsed since January 1, 1970 UTC.</p></blockquote>
<p>This is what printed to the terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733691162
</span></span></code></pre></div><p>That&rsquo;s a good start, but if we rerun that code, the timestamp value will change, while we&rsquo;d like to keep it stable for 30 seconds. Well, piece of cake, let&rsquo;s divide it by 30 and use that value as a base:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// gets current timestamp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gets a number that is stable within 30 seconds</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">base</span>)
</span></span></code></pre></div><p>Let&rsquo;s run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733691545
</span></span><span style="display:flex;"><span>Base:  57789718
</span></span></code></pre></div><p>And again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733691552
</span></span><span style="display:flex;"><span>Base:  57789718
</span></span></code></pre></div><p>The base value remains the same. Let&rsquo;s wait for a bit, and run it again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733691571
</span></span><span style="display:flex;"><span>Base:  57789719
</span></span></code></pre></div><p>The base value has changed, as the 30 seconds window has passed - good job!</p>
<p>If the &ldquo;divide by 30&rdquo; logic doesn&rsquo;t make sense, let me explain it with a simple example:</p>
<ul>
<li>imagine that our timestamp returns 1</li>
<li>if we divide 1 by 30, the result will be 0, as when we are using a strictly typed programming language, dividing integer by integer returns another integer, which isn&rsquo;t concerned about the floating-point part</li>
<li>this means that for the next 30 seconds we&rsquo;ll be getting <code>0</code> while timestamp is between 0 and 29</li>
<li>once timestamp reaches the value of 30, the result of division is 1, until 60 (where it becomes 2), and so on</li>
</ul>
<p>I hope it makes more sense now.</p>
<p>However, not all the requirements are satisfied yet, as we need a 6 digits result, while current base has 8 digits as of today, but at some point of time in the future it might reach 9 digits point, and so on. Well, let&rsquo;s use another simple math trick: let divide the base by 1 000 000, and get the remainder, which will always have exactly 6 digits, as the reminder can be any number from 0 to 999 999, but never larger:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">base</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// adds leading zeros if necessary:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">formattedCode</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code: &#34;</span>, <span style="color:#a6e22e">formattedCode</span>)
</span></span></code></pre></div><p>The <code>fmt.Sprintf(&quot;%06d&quot;, code)</code> part appends leading zeros in case if our code value has less than 6 digits. For example, <code>1234</code> will be converted into <code>001234</code>.
The entire code for this post can be found <a href="https://github.com/n0rdy/n0rdy-blog-code-samples/tree/main/20241210-otp-offline-generation" target="_blank" rel="nofollow">here</a>.</p>
<p>Let&rsquo;s run this code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733692423
</span></span><span style="display:flex;"><span>Base:  57789747
</span></span><span style="display:flex;"><span>Code:  789747
</span></span></code></pre></div><p>All right, we get our 6-digits code, hooray! But something doesn&rsquo;t feel right here, does it? If I give you this code, and you will run it at the same time as I do, you&rsquo;ll get the same code, as I. This doesn&rsquo;t make it a secure one-time password, right? Here comes a new requirement:</p>
<ul>
<li>the result should be different for different users</li>
</ul>
<p>Of course, some collisions are inevitable, if we have beyond 1 million users, as this is the max possible unique values per 6 digits. But these are rare and technically unavoidable collisions, not the algorithm design flaw like we have now.</p>
<p>I don&rsquo;t think any clever mathematical tricks will help us here on their own: if we need separate results per user, we need a user-specific state to make it happen. As engineers and, at the same time, users of many services, we know that to grant access to their APIs, services rely on private keys, which are unique per user. Let&rsquo;s introduce a private key for our use case as well to distinguish between the users.</p>
<h3 id="private-key">Private key</h3>
<p>A simple logic for generating private keys as integers between 1 000 000 and 999 999 999:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pkDb</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prForUser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nextPrivateKey</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Private key for user: &#34;</span>, <span style="color:#a6e22e">prForUser</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">nextPrivateKey</span>() <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">randomPrivateKey</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">pkDb</span>[<span style="color:#a6e22e">r</span>] {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span> = <span style="color:#a6e22e">randomPrivateKey</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pkDb</span>[<span style="color:#a6e22e">r</span>] = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// generates random number from 1 000 000 to 999 999 999</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">randomPrivateKey</span>() <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">999_999_999</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1_000_000</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We are using <code>pkDb</code> map as a way to prevent duplicates among private keys, and if the duplicate has been detected, we run the generation logic once more until we get a unique result.</p>
<p>Let&rsquo;s run this code to get the private key sample:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Private key for user:  115537846
</span></span></code></pre></div><p>Let&rsquo;s make a use of this private key within our code generation logic to make sure we are getting different results per private key. Since our private key is of integer type, the simplest thing we can do is to add it to the base value, and keep the remaining algorithm as it is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">int64</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">pk</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">base</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// adds leading zeros if necessary:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s make sure it produces different results for different private keys:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pkForUser1</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">115537846</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pkForUser2</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">715488689</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">codeForUser1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pkForUser1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code for user 1: &#34;</span>, <span style="color:#a6e22e">codeForUser1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">codeForUser2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pkForUser2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code for user 2: &#34;</span>, <span style="color:#a6e22e">codeForUser2</span>)
</span></span></code></pre></div><p>The outcome looks as we wanted and expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733695429
</span></span><span style="display:flex;"><span>Base:  173327693
</span></span><span style="display:flex;"><span>Code for user 1:  327693
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current timestamp:  1733695429
</span></span><span style="display:flex;"><span>Base:  773278536
</span></span><span style="display:flex;"><span>Code for user 2:  278536
</span></span></code></pre></div><p>Works like charm! This means that the private key should be injected into the device that generates codes before it is sent to the users like me: that should not be a problem at all for the banks.</p>
<p>Are we done now? Well, only if we are satisfied with the artificial scenario we used. If you have ever enabled the MFA for any services / websites you have account on, you might have noticed that the web resource asks you to scan the QR code with your second-factor app of choice (Authy, Google Authenticator, 2FAS, etc.) that will input the secret code into your app and start generating 6-digits code from that moment on. Alternatively, it is possible to enter the code manually.</p>
<p>I&rsquo;m bringing this up to mention that it is possible to take a peek at the format of the real private keys used in the industry. They are usually 16-32 characters long Base32-encoded strings that look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>JBSWY3DPEB2GQZLSMUQQ
</span></span></code></pre></div><p>As you can see, this is quite different from the integer private keys we used, and the current implementation of our algorithm won&rsquo;t work if we are to switch to this format. How can we adjust our logic?</p>
<h3 id="private-key-as-a-string">Private key as a string</h3>
<p>Let&rsquo;s start with a simple approach: our code won&rsquo;t compile, because of this line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span><span style="color:#f92672">/</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">pk</span>
</span></span></code></pre></div><p>as <code>pk</code> is of type <code>string</code> from now on. So why don&rsquo;t we convert it into integer? While there are way more elegant and performant ways to do that, here is the simplest thing I came up with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// converts the string pk to a number</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">num</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">char</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span> = <span style="color:#ae81ff">31</span><span style="color:#f92672">*</span><span style="color:#a6e22e">num</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">char</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is heavily inspired by the Java <code>hashCode()</code> implementation for the <code>String</code> data type, which makes it good-enough for our scenario.</p>
<p>Here is the adjusted logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pkForUser1</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">115537846</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pkForUser2</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">715488689</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">codeForUser1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pkForUser1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code for user 1: &#34;</span>, <span style="color:#a6e22e">codeForUser1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">codeForUser2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pkForUser2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code for user 2: &#34;</span>, <span style="color:#a6e22e">codeForUser2</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">int64</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">pk</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">base</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// adds leading zeros if necessary:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is the terminal output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733771953
</span></span><span style="display:flex;"><span>Base:  9056767456302232090
</span></span><span style="display:flex;"><span>Code:  232090
</span></span></code></pre></div><p>Nice, 6-digits code is there, good job. Let&rsquo;s wait to get to the next time window and run it again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733771973
</span></span><span style="display:flex;"><span>Base:  9056767456302232091
</span></span><span style="display:flex;"><span>Code:  232091
</span></span></code></pre></div><p>Hm&hellip;it works, but the code is, basically the increment of the previous value, which is not good, as this way OTPs are predictable, and having its value and knowing what time it belongs to, it is very simple to start generating the same values without the need of knowing the private key. Here is the simple pseudocode for this hack:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>now = currentTimestamp()
</span></span><span style="display:flex;"><span>diff = now - oldOtpTimestamp
</span></span><span style="display:flex;"><span>numOfOtpsIssuedSinceThen = diff / 30
</span></span><span style="display:flex;"><span>currentOtp = keepWithinSixDigits(oldOtp + numOfOtpsIssuedSinceThen)
</span></span></code></pre></div><p>where <code>keepWithinSixDigits</code> will make sure that after the <code>999 999</code> the next value is <code>000 000</code> and so on to keep the value within the 6-digits limit possibilities.</p>
<p>As you can see, it is a serious security flaw. Why does it happen? If we take a look at the <code>base</code> calculation logic, we&rsquo;ll see that it relies on 2 factors:</p>
<ul>
<li>current timestamp divided by 30</li>
<li>hash of the private key</li>
</ul>
<p>The hash produces the same value for the same key, so its value is constant. As for the <code>current / 30</code> , it has the same value for 30 seconds, but once the window has passed, the next value will be the increment of the previous one. Then <code>base % 1_000_000</code> behaves the way we see. Our previous implementation (with private keys as integers) had the same vulnerability, but we didn&rsquo;t notice that - lack of testing to blame.</p>
<p>We need to transform <code>current / 30</code> into something to make the change of its value more noticeable.</p>
<h3 id="distributed-otp-values">Distributed OTP values</h3>
<p>There are multiple ways to achieve that, and some cool math tricks exist out there, but for the educational purposes let&rsquo;s prioritize the readability of the solution we&rsquo;ll go with: let&rsquo;s extract <code>current / 30</code> into a separate variable <code>base</code> and include it into the hash computation logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// converts base and pk into a number</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">char</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span> = <span style="color:#ae81ff">31</span><span style="color:#f92672">*</span><span style="color:#a6e22e">num</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">char</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hash: &#34;</span>, <span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This way, even though the base will change with 1 every 30 seconds, after being used within the <code>hash()</code> function logic, the weight of the diff will increase due to the series of performed multiplications.</p>
<p>Here is the updated code example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pk</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;JBSWY3DPEB2GQZLSMUQQ&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">codeForUser1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code: &#34;</span>, <span style="color:#a6e22e">codeForUser1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// combines the base with the private key to get a number unique to the user:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">baseWithPk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span>, <span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">baseWithPk</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">baseWithPk</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// adds leading zeros if necessary:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// converts base and pk into a number</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">char</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span> = <span style="color:#ae81ff">31</span><span style="color:#f92672">*</span><span style="color:#a6e22e">num</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">char</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hash: &#34;</span>, <span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733773490
</span></span><span style="display:flex;"><span>Hash:  -1073062424175310899
</span></span><span style="display:flex;"><span>Base:  -1073062424175310899
</span></span><span style="display:flex;"><span>Code:  -310899
</span></span></code></pre></div><p>Boom! How come did we get the minus value here? Well, it seems like we ran out of the <code>int64</code> ranges, so it capped the values to the minus and started over - my Java fellows are familiar with this from the <code>hashCode()</code> behavior.  The fix is simple: let&rsquo;s take the absolute value from the result, so then the minus sign is ignored:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// combines the base with the private key to get a number unique to the user:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">baseWithPk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span>, <span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// makes sure it is positive:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">absBaseWithPk</span> <span style="color:#f92672">:=</span> int64(<span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Abs</span>(float64(<span style="color:#a6e22e">baseWithPk</span>)))
</span></span></code></pre></div><p>Here is entire code sample with the fix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pk</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;JBSWY3DPEB2GQZLSMUQQ&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">codeForUser1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code: &#34;</span>, <span style="color:#a6e22e">codeForUser1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Current timestamp: &#34;</span>, <span style="color:#a6e22e">current</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// combines the base with the private key to get a number unique to the user:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">baseWithPk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span>, <span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it is positive:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">absBaseWithPk</span> <span style="color:#f92672">:=</span> int64(<span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Abs</span>(float64(<span style="color:#a6e22e">baseWithPk</span>)))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Base: &#34;</span>, <span style="color:#a6e22e">absBaseWithPk</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">absBaseWithPk</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// adds leading zeros if necessary:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// converts base and pk into a number</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">base</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">char</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span> = <span style="color:#ae81ff">31</span><span style="color:#f92672">*</span><span style="color:#a6e22e">num</span> <span style="color:#f92672">+</span> int64(<span style="color:#a6e22e">char</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hash: &#34;</span>, <span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733774391
</span></span><span style="display:flex;"><span>Hash:  3581577654419246315
</span></span><span style="display:flex;"><span>Base:  3581577654419246080
</span></span><span style="display:flex;"><span>Code:  246080
</span></span></code></pre></div><p>Let&rsquo;s run it again to make sure that the OTP values are distributed now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Current timestamp:  1733774402
</span></span><span style="display:flex;"><span>Hash:  4351623792829383276
</span></span><span style="display:flex;"><span>Base:  4351623792829383168
</span></span><span style="display:flex;"><span>Code:  383168
</span></span></code></pre></div><p>Nice, finally a decent solution!</p>
<p>Actually, that was the moment when I stopped my manual implementation process, as I had my share of fun and learned something new. However, it&rsquo;s neither the best solution nor the one I&rsquo;d go live with. Among other things, it has a big flaw: as you can see, our logic always deals with big numbers due to the hashing logic and timestamp values, which means that it&rsquo;s highly unlikely for us to be able to generate results that start with 1 or more zeros: e.g., <code>012345</code> , <code>001234</code>, etc., even though they are completely valid. Due to that, we are 100 000 possible values short, which is 10% from the possible number of outcomes of the algorithm - the chances of collisions are higher this way. Not cool!</p>
<h3 id="where-to-go-from-here">Where to go from here</h3>
<p>I won&rsquo;t go deep into the implementation that is used in the real applications, but for those who are curious, I&rsquo;ll share two RFCs worth taking a look at:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4226" target="_blank" rel="nofollow">HOTP: An HMAC-Based One-Time Password Algorithm</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6238" target="_blank" rel="nofollow">TOTP: Time-Based One-Time Password Algorithm</a></li>
</ul>
<p>And here is the pseudocode implementation that will work the intended way based on the RFCs above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>function generateTOTP(secretKey):
</span></span><span style="display:flex;"><span>    current = time.now().unix()
</span></span><span style="display:flex;"><span>    counter = floor(currentTime / 30)
</span></span><span style="display:flex;"><span>    hmac = HMAC-SHA1(secretKey, counter)
</span></span><span style="display:flex;"><span>    offset = last_byte(hmac) &amp; 0x0F
</span></span><span style="display:flex;"><span>    truncatedHash = hmac[offset:offset+4]  // Extract 4 bytes
</span></span><span style="display:flex;"><span>    binary = truncatedHash &amp; 0x7FFFFFFF    // Ensure positive number
</span></span><span style="display:flex;"><span>    otp = binary % 1_000_000               // Reduce to desired length
</span></span><span style="display:flex;"><span>    return otp
</span></span></code></pre></div><p>As you can see, we got very close to that, but the original algorithm uses more advanced hashing (HMAC-SHA1 in this example), and performs some bitwise operations to normalize the output.</p>
<h2 id="security-considerations-reuse-rather-than-build-yourself">Security considerations: reuse rather than build yourself</h2>
<p>However, there is one more thing I&rsquo;d like to cover before we call it a day: security. I&rsquo;d strongly encourage you against implementing the logic of generating OTPs on your own, as there are plenty of libraries out there that have it done for us. The room for error is huge, and it&rsquo;s a short distance to the vulnerability that will be discovered and exploited by the bad actors out there.</p>
<p>Even if you get the generation logic right and will cover it with tests, there are other things that can go wrong. For example, how much do you think it will take to brute-force the 6-digit code? Let&rsquo;s experiment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pk</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;JBSWY3DPEB2GQZLSMUQQ&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Code: &#34;</span>, <span style="color:#a6e22e">code</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// brute forces the OTP and measures the time it takes to find it in milliseconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">1_000_000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%06d&#34;</span>, <span style="color:#a6e22e">i</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatInt</span>(<span style="color:#a6e22e">code</span>, <span style="color:#ae81ff">10</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Found: &#34;</span>, <span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">finish</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Time: &#34;</span>, <span style="color:#a6e22e">finish</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Milliseconds</span>(), <span style="color:#e6db74">&#34;ms&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateCode</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets current timestamp:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Unix</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gets a number that is stable within 30 seconds:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">base</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">current</span><span style="color:#f92672">/</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">pk</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// makes sure it has only 6 digits:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">1_000_000</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// converts the string pk to a number</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">pk</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">int64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">num</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">num</span> <span style="color:#f92672">+=</span> int64(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s run this code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Code:  661504
</span></span><span style="display:flex;"><span>Found:  661504
</span></span><span style="display:flex;"><span>Time:  75 ms
</span></span></code></pre></div><p>And once more:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>Code:  524928
</span></span><span style="display:flex;"><span>Found:  524928
</span></span><span style="display:flex;"><span>Time:  67 ms
</span></span></code></pre></div><p>As you can see, it takes around 70 ms to guess the code via simple brute-forcing for-loop. That&rsquo;s 400+ times faster than the lifetime of the OTP! The server of the app/website using OTP mechanism needs to prevent that by, for example, not accepting new codes for the next 5 or 10 seconds after 3 failed attempts. This way the attacker gets only 18 or 9 attempts correspondingly within the 30 seconds window, which is not enough for the pool of 1 million possible values.</p>
<p>And there are other things like this that are easy to overlook. So, let me repeat: don&rsquo;t build this from scratch, but rely on the existing solutions.</p>
<p>Anyway, I hope you learned something new today, and the OTP logic won&rsquo;t be a mystery for you from this point on. Also, if at some point in life, you&rsquo;ll need to make your offline device generate some values using a reproducible algorithm, you have a good idea where to start.</p>
<p>Thanks for the time you spent reading this post, and have fun! =)</p>

  
    <hr>
<div class="newsletters">
    <div class="help-block-for-success"></div>
    <div class="help-block-for-error"></div>
    <form id="email-subscription-form">
        <label for="email-subscription-input">Receive an email once a new post is published</label>
        <input type="email" id="email-subscription-input" name="email-subscription-input" placeholder="Email address" />
        <button type="submit">Subscribe</button>
    </form>

    <script>
      const listmonkHost = "https://mail.n0rdy.foo";
      const listmonkSubscriptionSuccessMessage = "Almost there! =) Please, check your email to confirm subscription. Check your spam folder if you didn't get the email.";
      const listmonkSubscriptionErrorMessage = "Something went wrong =( Please, try again later.";

      const form = document.getElementById("email-subscription-form");
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = form.querySelector("#email-subscription-input").value;
        const data = {
          email: email,
          list_uuids: [
            "3ba79b71-880f-417d-9587-d388b62e0986"
          ]
      };
        fetch(`${listmonkHost}/api/public/subscription`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        }).then((response) => {
          if (response.status === 200) {
            const successBlock = document.getElementsByClassName('help-block-for-success')[0];
            successBlock.classList.add('help-block-show');
            successBlock.textContent = listmonkSubscriptionSuccessMessage;
            document.getElementById('email-subscription-form').classList.add('email-subscription-form-hide');
          } else {
            const errorBlock = document.getElementsByClassName('help-block-for-error')[0];
            errorBlock.classList.add('help-block-show');
            errorBlock.textContent = listmonkSubscriptionErrorMessage;
          }
        }).catch(() => {
          const errorBlock = document.getElementsByClassName('help-block-for-error')[0];
          errorBlock.classList.add('help-block-show');
          errorBlock.textContent = listmonkSubscriptionErrorMessage;
        });
      })
    </script>
</div>
  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://n0rdy.foo/posts/20240328/jwt-jws-jwe-and-how-to-cook-them/?ref=footer"><span style="font-weight:bold;"> Previous</span><br>JWT, JWS, JWE and how to cook them</a>
        
	    
            <div class="next-post">
                <a href="https://n0rdy.foo/posts/20250118/til-ghostty/?ref=footer"><span style="font-weight:bold;">Next </span><br>TIL: Ghostty - a new and quite promising terminal...</a>
            </div>
        
    
</div>

  
    <div class="comments">
    
        <div id="remark42"></div>
        <script>
            themeFromLS = localStorage.getItem("theme")
            themeFromHugo = document.body.classList.contains("dark-theme") ? "dark" : "light"
            currentTheme = themeFromLS ? themeFromLS : themeFromHugo;

            var remark_config = {
                host: "https://www.remark42.n0rdy.foo",
                site_id: "remark42.n0rdy.foo",
                theme: currentTheme,
                max_shown_comments: 100,
            }
        </script>
        <script>!function(e,n){for(var o=0;o<e.length;o++){var r=n.createElement("script"),c=".js",d=n.head||n.body;"noModule"in r?(r.type="module",c=".mjs"):r.async=!0,r.defer=!0,r.src=remark_config.host+"/web/"+e[o]+c,d.appendChild(r)}}(remark_config.components||["embed"],document);</script>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#the-big-question">The big question</a>
      <ul>
        <li><a href="#challenges">Challenges</a></li>
      </ul>
    </li>
    <li><a href="#implementation">Implementation</a>
      <ul>
        <li><a href="#private-key">Private key</a></li>
        <li><a href="#private-key-as-a-string">Private key as a string</a></li>
        <li><a href="#distributed-otp-values">Distributed OTP values</a></li>
        <li><a href="#where-to-go-from-here">Where to go from here</a></li>
      </ul>
    </li>
    <li><a href="#security-considerations-reuse-rather-than-build-yourself">Security considerations: reuse rather than build yourself</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
